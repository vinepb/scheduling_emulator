function Vbat = battery(SoC,I,T,ts)
persistent Vc1_old Vc2_old 

SOC=[0.1692    0.2616    0.3539    0.4460    0.5385    0.6308    0.7228    0.8154    0.9077    1.0000];
C1_ = [2450.7 2732.3 3213.3 2731.2 2551.6 1987.3 3984 1817.2 1820.6 2556.7];
C2_ = [8597.9 11802 34479 1.1331e+05 1.5808e+05 16754 12634 1.676e+05 29568 20551];
Em_ = [3.6453 3.6631 3.6969 3.7309 3.777 3.8463 3.9044 3.9876 4.0862 4.1806];
R0_ = [0.073212 0.068165 0.067681 0.064431 0.063966 0.061906 0.074052 0.065286 0.063708 0.063155];
R1_ = [0.046165 0.043924 0.045182 0.039196 0.030881 0.028694 0.041718 0.044182 0.031082 0.030043];
R2_ = [5.313 3.277 0.75409 0.41169 0.25635 0.92289 1.0759 0.80809 0.80858 4.8707];

if isempty(Vc1_old)
    Vc1_old=0;
    Vc2_old=0;
end

R1=interp1(SOC,R1_,SoC);
R2=interp1(SOC,R2_,SoC);
C1=interp1(SOC,C1_,SoC);
C2=interp1(SOC,C2_,SoC);
R0=interp1(SOC,R0_,SoC);
Em=interp1(SOC,Em_,SoC);



Vc1=Vc1_old+1/C1*(I-Vc1_old/R1)*ts;
Vc2=Vc2_old+1/C2*(I-Vc2_old/R2)*ts;

Vbat=Em + Vc1 + Vc2 + R0 * I;


Vc1_old=Vc1;
Vc2_old=Vc2;

